# Base development container
FROM mcr.microsoft.com/vscode/devcontainers/javascript-node:0-18

# Install additional development tools
RUN apt-get update && export DEBIAN_FRONTEND=noninteractive \
    && apt-get -y install --no-install-recommends \
    git \
    curl \
    vim \
    postgresql-client \
    && apt-get clean -y \
    && rm -rf /var/lib/apt/lists/*

# Install global development dependencies
RUN npm install -g typescript @types/node ts-node nodemon

# Install Python for ML features
RUN apt-get update && apt-get install -y python3 python3-pip \
    && pip3 install --no-cache-dir \
    numpy \
    pandas \
    scikit-learn \
    tensorflow

# Setup workspace directory
WORKDIR /workspace

# Copy package files
COPY package*.json ./

# Install dependencies
RUN npm install

# Copy source code
COPY . .

# Expose ports
EXPOSE 3000 5000 8080

# Command to run development server
CMD ["npm", "run", "dev"]

# Development container configuration
version: '3'
services:
  app:
    build: 
      context: .
      dockerfile: Dockerfile
    volumes:
      - ..:/workspace:cached
    command: sleep infinity
    network_mode: service:db

  db:
    image: postgres:latest
    restart: unless-stopped
    volumes:
      - postgres-data:/var/lib/postgresql/data
    environment:
      POSTGRES_PASSWORD: postgres
      POSTGRES_USER: postgres
      POSTGRES_DB: platform_db

volumes:
  postgres-data: